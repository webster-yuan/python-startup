# 认证系统说明文档（基于当前实现）

## 一、概述

本项目实现了基于 **JWT Access Token** + **Refresh Session（opaque token + rotation）** 的认证系统，支持：

- ✅ 用户注册和登录
- ✅ Access Token 鉴权（短期有效）
- ✅ Refresh Token（不透明字符串）轮换刷新 Access Token（Refresh Rotation）
- ✅ Logout（撤销 refresh 会话）
- ✅ 用户信息查询（`/auth/me`）
- ✅ 密码安全（bcrypt + 72 字节限制保护）
- ✅ 基础防护：限流、可信代理链下的真实客户端 IP 解析
- ✅ JWT 企业基线：`iss/aud` 校验、`kid`、多 key 验证（便于密钥轮换）

## 二、认证架构（当前代码）

### 2.1 Token 与会话类型

**1) Access Token（JWT）**
- **用途**：访问受保护的 API（例如 `GET /auth/me`、`POST /hero/hero`）
- **有效期**：默认 **10 分钟**（`ACCESS_TOKEN_EXPIRE_MINUTES`）
- **携带方式**：

```
Authorization: Bearer <access_token>
```

- **关键声明（claims）**
  - `sub`: **user_id（字符串）**（不可变标识）
  - `type`: `access`
  - `iss` / `aud`: 由配置决定（强校验）
  - `exp` / `iat`
  - header: `kid`

**2) Refresh Token（opaque string，不透明随机串）**
- **用途**：用于刷新 access token，不用于访问业务 API
- **有效期**：默认 7 天（`REFRESH_TOKEN_EXPIRE_DAYS`）
- **服务端存储**：不存明文，仅存 **sha256(refresh_token)** 的 hash（见 `AuthSession.refresh_token_hash`）
- **刷新策略**：**Refresh Rotation**
  - 每次刷新都会生成 **新的 refresh_token** 并撤销旧的会话

### 2.2 AuthSession（会话表）

Refresh 会话由 `AuthSession` 表管理（模型：`webster_api/models/auth_session.py`），核心字段：
- `refresh_token_hash`：sha256(refresh_token)，**唯一**
- `created_at/expires_at`
- `revoked_at`（撤销时间）
- `replaced_by_hash`（被哪个新 token 取代）
- `created_ip/user_agent`（最小风控/审计字段）

### 2.3 流程图（当前行为）

```
1) 注册 POST /auth/register
   ↓
2) 登录 POST /auth/login（form）
   ↓
   返回：access_token(JWT) + refresh_token(opaque)
   写入：AuthSession(hash, expires, created_ip, user_agent)
   ↓
3) 访问业务 API（带 Authorization: Bearer <access_token>）
   ↓
4) access 过期 → 刷新 POST /auth/refresh（body: refresh_token）
   ↓
   返回：新 access_token + 新 refresh_token（rotation）
   写入：新 AuthSession；撤销旧 AuthSession
   ↓
5) 登出 POST /auth/logout（body: refresh_token）
   ↓
   撤销 AuthSession（refresh 失效）

注意：logout 不会让已签发的 access_token 立即失效（企业常见做法：access 短时效）。
```

## 三、API 端点说明

### 3.1 用户注册

- **端点**：`POST /auth/register`
- **请求体**：

```json
{"username":"testuser","email":"test@example.com","password":"password123"}
```

- **响应（201）**：`UserRead`

### 3.2 用户登录（OAuth2 Password Form）

- **端点**：`POST /auth/login`
- **Content-Type**：`application/x-www-form-urlencoded`
- **参数**：`username`、`password`

```bash
curl -X POST "http://localhost:8000/auth/login" ^
  -H "Content-Type: application/x-www-form-urlencoded" ^
  -d "username=testuser&password=password123"
```

- **响应（200）**：

```json
{
  "access_token": "<JWT>",
  "refresh_token": "<opaque string>",
  "token_type": "bearer"
}
```

### 3.3 刷新 Token（Refresh Rotation）

- **端点**：`POST /auth/refresh`
- **请求体**：

```json
{"refresh_token":"<opaque string>"}
```

- **响应（200）**：会返回 **新的 access_token + 新的 refresh_token**

```json
{
  "access_token": "<new JWT>",
  "refresh_token": "<new opaque string>",
  "token_type": "bearer"
}
```

### 3.4 Logout（撤销 refresh 会话）

- **端点**：`POST /auth/logout`
- **请求体**：

```json
{"refresh_token":"<opaque string>"}
```

- **响应（204）**：幂等（token 不存在/已撤销也返回 204）

> 说明：logout 仅撤销 refresh，会导致 **无法继续 refresh**；已签发 access 在其过期前仍可使用（默认 10 分钟）。

### 3.5 获取当前用户信息

- **端点**：`GET /auth/me`
- **Header**：

```
Authorization: Bearer <access_token>
```

## 四、鉴权与错误码语义

### 4.1 鉴权方式

鉴权依赖位于：`webster_api/core/deps.py`
- 使用 `OAuth2PasswordBearer(tokenUrl="/auth/login")`（OpenAPI/Swagger 展示一致）
- token 解码失败/缺失/类型不匹配 → 统一返回：
  - **401**
  - body: `{"detail":"Could not validate credentials"}`
  - header: `WWW-Authenticate: Bearer`

### 4.2 典型业务错误码

- 注册用户名/邮箱冲突：`UserExistsError` → **409 Conflict**
- 登录失败：`AuthenticationError` → **401**
- refresh token 无效/过期/已撤销：`RefreshTokenError` → **401**

## 五、限流与真实客户端 IP

### 5.1 限流

当前为内存限流（单进程开发版），并做了 DoS 保护：最大 key 数 + LRU/TTL 淘汰。

- `/auth/login`：按 `IP + username` 限流（10 次/60 秒）
- `/auth/refresh`：按 `IP` 限流（30 次/60 秒）
- `/auth/logout`：按 `IP` 限流（60 次/60 秒）

> 生产多 Pod 场景建议使用 Redis 限流（跨实例生效）。

### 5.2 真实客户端 IP（可信代理链）

默认不信任 `X-Forwarded-For/X-Real-IP`，只有当对端 `request.client.host` 位于 `TRUSTED_PROXIES` 中才会解析，防伪造。

示例（PowerShell）：

```powershell
$env:TRUST_PROXY_HEADERS="true"
$env:TRUSTED_PROXIES="127.0.0.1,10.0.0.0/8,192.168.0.0/16"
```

## 六、JWT 企业基线：iss/aud + kid + 多 key 验证

当前实现会：
- 签发时写入 `iss/aud`，并在解码时强校验
- header 写入 `kid`
- 通过 `JWT_KEYRING_JSON` 支持多 key 验证，便于密钥轮换期验证旧 token

示例：

```env
JWT_ISSUER=webster-api
JWT_AUDIENCE=webster-api
JWT_SIGNING_KID=default
# JSON 字符串（用于验证旧 key）；当前 key 始终来自 SECRET_KEY
JWT_KEYRING_JSON={"v0":"<old-secret>"}
```

## 七、Swagger 自测注意点

- Swagger 的 **Authorize** 会缓存 access token；调用 `/auth/logout` 不会自动清除 Authorization header。
- 你看到 “logout 后仍能访问业务接口” 是因为：access token 是无状态 JWT，且默认 10 分钟过期。
  - 这是企业常见方案：**access 短时效 + logout 只撤销 refresh**。

## 八、配置项速查（env.example）

重点配置：
- `ENVIRONMENT`（development/production）
- `SECRET_KEY`、`ALGORITHM`
- `JWT_ISSUER`、`JWT_AUDIENCE`、`JWT_SIGNING_KID`、`JWT_KEYRING_JSON`
- `ACCESS_TOKEN_EXPIRE_MINUTES`（默认 10）
- `REFRESH_TOKEN_EXPIRE_DAYS`（默认 7）
- `TRUST_PROXY_HEADERS`、`TRUSTED_PROXIES`

---

**文档版本**：2.0  
**最后更新**：2026-01-19  
