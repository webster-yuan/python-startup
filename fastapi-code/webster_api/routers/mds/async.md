在 FastAPI 中使用 `async` 来定义接口处理函数是为了支持 **异步编程**，使得在处理 HTTP 请求时能够更高效地处理 I/O
密集型任务，比如数据库查询、外部 API 请求、文件操作等。

### 为什么使用 `async`？

1. **异步 I/O 操作**：

    * 当请求需要等待外部资源时（比如数据库查询、调用其他服务的 API），使用 `async` 可以让 FastAPI 在等待这些操作的同时，不会阻塞其他请求的处理。
    * 例如，当进行数据库查询时，如果没有使用异步处理，服务器会被阻塞，直到查询完成才能继续处理其他请求。这样会导致性能瓶颈，尤其在高并发的情况下。而使用异步函数时，FastAPI
      会将等待操作交给事件循环，释放 CPU 资源去处理其他请求，从而提高并发性能。

2. **高并发的场景**：

    * 在高并发的 Web 应用中，通常会有很多请求在同一时间到达，尤其是涉及到外部服务、数据库的操作时。异步编程允许在等待 I/O
      响应的同时，继续处理其他请求，避免了阻塞，提高了服务器的吞吐量和响应速度。
    * 比如如果你的应用需要同时处理多个用户登录请求，通过异步，你的服务能够在等待数据库响应的同时，继续处理其他用户的请求，而不是一个一个地排队等。

3. **性能优化**：

    * FastAPI 的设计思想就是为了 **高性能**，并且 FastAPI 是基于 **Starlette**（一个高性能的异步框架）构建的，异步编程和
      `async`/`await` 使得它能够提供 **更高的并发处理能力**。
    * 它通过在事件循环中执行 I/O 操作来避免线程阻塞，允许同一进程处理更多的请求，从而有效提高性能。

### 示例：同步 vs 异步

假设你需要在处理登录请求时查询一个数据库或调用外部认证服务。

#### 同步处理：

```python
from fastapi import FastAPI, Form
from time import sleep

app = FastAPI()


@app.post("/loginV2")
def login_v2(username: str = Form(...), password: str = Form(...)):
    sleep(2)  # 模拟长时间的数据库查询或外部请求
    return {"username": username, "password": password}
```

在这个例子中，`sleep(2)` 模拟了一个 I/O 阻塞操作。如果有 100 个请求来访问这个接口，服务器会依次处理，每个请求都需要等待 2
秒钟，导致响应变慢，且处理能力降低。

#### 异步处理：

```python
from fastapi import FastAPI, Form
import asyncio

app = FastAPI()


@app.post("/loginV2")
async def login_v2(username: str = Form(...), password: str = Form(...)):
    await asyncio.sleep(2)  # 模拟异步数据库查询或外部请求
    return {"username": username, "password": password}
```

这里使用了 `async def` 和 `await` 来定义异步接口。`await asyncio.sleep(2)` 模拟的是异步操作，意味着当服务等待 2
秒钟时，它可以继续处理其他请求，而不是阻塞整个线程。当有 100 个请求时，FastAPI 会同时处理多个请求，而不是一一等待，因此它能提供更好的性能和响应速度。

### 什么时候不需要 `async`？

* 如果你的接口处理函数是纯计算密集型操作，没有 I/O 操作（例如计算任务），则使用同步函数（不需要 `async`
  ）即可，因为没有外部资源的调用，异步不会带来额外的性能提升。
* 如果你不涉及文件上传、数据库查询、外部 API 调用等会阻塞主线程的操作，也可以不使用 `async`。

### 总结

使用 `async` 可以让 FastAPI 更好地应对 **I/O 密集型任务** 和 **高并发** 请求，通过异步方式提高服务器的吞吐量和响应速度。但如果接口的工作完全是计算密集型任务且不涉及
I/O 操作，使用同步函数同样可以达到良好的性能效果。

如果是面试题，可以这样回答：

> FastAPI 使用 `async` 来定义接口处理函数是为了支持异步编程，特别是对 I/O 密集型任务的高效处理。通过异步编程，FastAPI
> 可以在等待数据库查询、外部 API 调用等操作时，释放线程去处理其他请求，从而提升系统的吞吐量和响应速度。对于没有 I/O
> 阻塞的纯计算任务，可以不使用 `async`，以避免不必要的复杂性。
