“中间件”是一个在任何特定路径操作处理之前，与每个请求协同工作的函数。同时，它也是在返回每个响应之前与之协同工作的函数。

它接收进入应用程序的每个请求。
然后它可以对该请求执行某些操作或运行任何必要的代码。

然后它将请求传递给应用程序的其余部分（由某个路径操作）进行处理。

然后它接收应用程序（由某个路径操作）生成的响应。

然后它可以对该响应执行某些操作或运行任何必要的代码。

然后它返回响应。

如果您有带有 yield 的依赖项，则退出代码将在中间件之后运行。

如果有任何后台任务，它们将在所有中间件之后运行。

多个中间件的执行顺序

当您使用 @app.middleware() 装饰器或 app.add_middleware() 方法添加多个中间件时，每个新中间件都会包装应用程序，形成一个堆栈。最后添加的中间件是最外层的，第一个添加的是最内层的。

在请求路径上，最外层的中间件首先运行。

在响应路径上，它最后运行。

例如

app.add_middleware(MiddlewareA)
app.add_middleware(MiddlewareB)
这导致了以下执行顺序

请求：MiddlewareB → MiddlewareA → 路由

响应：路由 → MiddlewareA → MiddlewareB