### **数据有效性检查规范**

#### **1. 从模块外部读取的数据必须检查有效性 【强制】**

**理由**：  
外部数据的来源多种多样，可能会包含无效、错误或恶意数据。未经验证的数据如果直接进入程序逻辑，可能导致程序崩溃、数据泄露或安全漏洞。因此，必须在进入主逻辑前对外部数据进行严格的有效性检查。

**常见场景**：
- 文件输入
- 数据库查询
- 标准输入（CLI）
- 网络请求（Socket、HTTP 等）
- RPC 调用返回值

---

**示例**：

**文件数据检查**：
```python
def read_and_validate_file(file_path):
    """
    读取文件并验证内容。

    参数:
    file_path (str): 文件路径。

    返回:
    list: 验证后的数据列表。

    异常:
    FileNotFoundError: 当文件不存在时抛出。
    ValueError: 当文件内容无效时抛出。
    """
    if not os.path.exists(file_path):
        raise FileNotFoundError(f"文件 {file_path} 不存在")

    with open(file_path, 'r') as file:
        data = file.readlines()

    # 验证文件内容
    validated_data = [line.strip() for line in data if line.strip()]
    if not validated_data:
        raise ValueError("文件内容为空或无效")

    return validated_data
```

**数据库结果检查**：
```python
def fetch_user_by_id(user_id, db_connection):
    """
    从数据库中获取用户信息并验证。

    参数:
    user_id (int): 用户ID。
    db_connection (object): 数据库连接对象。

    返回:
    dict: 用户信息。

    异常:
    ValueError: 当查询结果为空或数据无效时抛出。
    """
    cursor = db_connection.cursor()
    cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
    user = cursor.fetchone()

    if not user:
        raise ValueError(f"用户ID {user_id} 不存在")
    
    return user
```

---

#### **2. 模块外部读取数据的检查方式建议封装成函数，并通过抛异常来处理不合法数据 【建议】**

**理由**：  
- 封装检查逻辑有助于代码复用，提高模块化程度。
- 使用异常能清晰地捕获并处理无效数据，避免主逻辑被污染。

---

**示例**：

**封装数据验证函数**：
```python
def validate_user_data(data):
    """
    验证用户数据格式。

    参数:
    data (dict): 用户数据字典。

    异常:
    KeyError: 缺少必要的键时抛出。
    ValueError: 数据类型或值无效时抛出。
    """
    required_keys = ['id', 'name', 'email']
    for key in required_keys:
        if key not in data:
            raise KeyError(f"缺少必要的字段: {key}")

    if not isinstance(data['id'], int) or data['id'] <= 0:
        raise ValueError("用户ID必须为正整数")
    if '@' not in data['email']:
        raise ValueError("无效的邮箱地址")

def process_user_data(raw_data):
    """
    处理用户数据，先进行验证。

    参数:
    raw_data (dict): 从外部读取的用户数据。

    返回:
    dict: 验证后的用户数据。
    """
    validate_user_data(raw_data)
    # 继续处理数据
    return raw_data
```

---

### **错误示例**：

**未检查外部数据直接使用**：
```python
def process_user_data(raw_data):
    # 假设数据总是正确的
    user_id = raw_data['id']
    user_email = raw_data['email']
    # 后续逻辑依赖数据的正确性，但如果数据无效会引发错误
```

---

### **总结规范**

| **规则**                                           | **解释**                                                                 |
|----------------------------------------------------|--------------------------------------------------------------------------|
| **所有外部数据必须检查有效性**                     | 任何从文件、数据库、网络等外部来源获取的数据，必须先验证后使用，确保安全。       |
| **检查逻辑建议封装成函数**                          | 避免重复编写验证逻辑，提高代码复用性，同时增强代码的结构化和可读性。               |
| **抛出异常处理无效数据**                            | 对于无效数据，使用异常清晰表达错误，便于错误处理和调试。                           |

通过上述规范，可以有效防止外部无效数据导致的程序错误，提高系统的稳定性和安全性。